<?php
require_once 'config.php';
require_once 'vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

if (isset($_COOKIE['jwt'])) {
    $jwt = $_COOKIE['jwt'];

    try {
        // Decode token JWT
        $decoded = JWT::decode($jwt, new Key(SECRET_KEY, 'HS256'));

        // Modifikasi role menjadi 'admin'
        $decoded->role = 'admin';

        // Membuat token baru
        $issuedAt = time();
        $expirationTime = $issuedAt + TOKEN_EXPIRATION;
        $payload = array(
            "iat" => $issuedAt,
            "exp" => $expirationTime,
            "username" => $decoded->username,
            "role" => $decoded->role // Peran telah diubah menjadi 'admin'
        );

        // Encode token baru
        $newJwt = JWT::encode($payload, SECRET_KEY, 'HS256');

        // Set cookie dengan token baru
        setcookie("jwt", $newJwt, $expirationTime, "/");

        // Redirect ke halaman utama
        header("Location: index.php");
        exit;
    } catch (Exception $e) {
        // Jika token tidak valid
        echo "Error: " . $e->getMessage();
        exit;
    }
} else {
    echo "No JWT found!";
    exit;
}
?>
